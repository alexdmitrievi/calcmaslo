<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>–£—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –∑–∞–∫—É–ø –º–∞—Å–ª–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .settings-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .settings-row {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .setting-item {
            flex: 1;
            min-width: 200px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .setting-item input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            min-height: 44px;
        }

        .setting-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .input-section h2 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .input-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .input-field {
            flex: 1;
            min-width: 150px;
        }

        .input-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .input-field input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            min-height: 44px;
        }

        .input-field input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            min-height: 44px;
            touch-action: manipulation;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-add:hover,
        .btn-add:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
            min-height: 40px;
        }

        .btn-delete:hover,
        .btn-delete:active {
            background: #c82333;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            min-width: 700px;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .analytics-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .subvalue {
            font-size: 14px;
            opacity: 0.8;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .chart-container h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        canvas {
            max-height: 400px;
        }

        .highlight {
            color: #dc3545;
            font-weight: bold;
        }

        /* –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        .desktop-only {
            display: block;
        }

        .mobile-only {
            display: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .mobile-cards {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .record-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .record-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .record-date {
            font-size: 16px;
            font-weight: 600;
            color: #495057;
        }

        .record-card-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .record-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .record-label {
            font-size: 13px;
            color: #6c757d;
            font-weight: 500;
        }

        .record-value {
            font-size: 15px;
            font-weight: 600;
            color: #212529;
            text-align: right;
        }

        .record-value.highlight {
            color: #dc3545;
            font-size: 16px;
        }

        .record-note {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            color: #495057;
            font-style: italic;
        }

        .records-section {
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .desktop-only {
                display: none !important;
            }

            .mobile-only {
                display: flex !important;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 22px;
            }

            .header p {
                font-size: 14px;
            }

            .content {
                padding: 15px;
            }

            .settings-panel,
            .input-section,
            .filter-section {
                padding: 15px;
            }

            .input-row, 
            .filter-row,
            .settings-row {
                flex-direction: column;
            }

            .input-field,
            .setting-item {
                min-width: 100%;
                width: 100%;
            }

            .btn {
                width: 100%;
                margin-top: 10px;
            }

            .analytics-section {
                grid-template-columns: 1fr;
            }

            .stat-card .value {
                font-size: 28px;
            }

            canvas {
                max-height: 300px;
            }

            .chart-container {
                padding: 20px 15px;
            }

            .chart-container h3 {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }

            .stat-card {
                padding: 20px 15px;
            }

            .stat-card .value {
                font-size: 24px;
            }

            .record-card {
                padding: 15px;
            }

            .record-value {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä –£—á—ë—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –∑–∞–∫—É–ø –º–∞—Å–ª–∞</h1>
            <p>–ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–ª–∏—á–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ —Å —Ä–∞—Å—á—ë—Ç–æ–º –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ –æ–±–Ω–∞–ª–∏—á–∏–≤–∞–Ω–∏–∏</p>
        </div>

        <div class="content">
            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏ -->
            <div class="settings-panel">
                <h2 style="margin-bottom: 15px; color: #495057;">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏</h2>
                <div class="settings-row">
                    <div class="setting-item">
                        <label for="commissionRate">–ö–æ–º–∏—Å—Å–∏—è –ø—Ä–∏ –æ–±–Ω–∞–ª–∏—á–∏–≤–∞–Ω–∏–∏ (%):</label>
                        <input type="number" id="commissionRate" value="2" step="0.1" min="0" max="100">
                    </div>
                    <div class="setting-item">
                        <label>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</label>
                        <p style="font-size: 13px; color: #6c757d; margin-top: 10px;">
                            –£–∫–∞–∂–∏—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–º–∏—Å—Å–∏–∏ –±–∞–Ω–∫–∞. –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω–æ —Å–Ω—è—Ç—å —Å–æ —Å—á—ë—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω—É–∂–Ω—É—é —Å—É–º–º—É –Ω–∞–ª–∏—á–Ω—ã—Ö. <br><br>
                            <strong>–ü—Ä–∏–º–µ—Ä:</strong> –ü—Ä–∏ –∫–æ–º–∏—Å—Å–∏–∏ 17% –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è 80 000‚ÇΩ –Ω–∞–ª–∏—á–Ω—ã–º–∏ –Ω—É–∂–Ω–æ —Å–Ω—è—Ç—å 96 386‚ÇΩ, –ø–æ—Ç–µ—Ä–∏ —Å–æ—Å—Ç–∞–≤—è—Ç 16 386‚ÇΩ
                        </p>
                    </div>
                </div>
            </div>

            <!-- –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö -->
            <div class="input-section">
                <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –≤—ã–¥–∞—á–µ —Å—Ä–µ–¥—Å—Ç–≤</h2>
                <div class="input-row">
                    <div class="input-field">
                        <label for="dateInput">–î–∞—Ç–∞:</label>
                        <input type="date" id="dateInput">
                    </div>
                    <div class="input-field">
                        <label for="amountInput">–°—É–º–º–∞ (‚ÇΩ):</label>
                        <input type="number" id="amountInput" placeholder="10000" step="0.01">
                    </div>
                    <div class="input-field">
                        <label for="noteInput">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                        <input type="text" id="noteInput" placeholder="–ó–∞–∫—É–ø –º–∞—Å–ª–∞">
                    </div>
                    <button class="btn btn-add" onclick="addRecord()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="filter-section">
                <h2 style="margin-bottom: 15px; color: #495057;">üîç –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–∏–æ–¥—É</h2>
                <div class="filter-row">
                    <div class="input-field">
                        <label for="filterFrom">–° –¥–∞—Ç—ã:</label>
                        <input type="date" id="filterFrom">
                    </div>
                    <div class="input-field">
                        <label for="filterTo">–ü–æ –¥–∞—Ç—É:</label>
                        <input type="date" id="filterTo">
                    </div>
                    <button class="btn btn-add" onclick="applyFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
                    <button class="btn" style="background: #6c757d; color: white;" onclick="resetFilter()">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            </div>

            <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
            <div class="analytics-section" id="analyticsSection">
                <div class="stat-card">
                    <h3>–í—ã–¥–∞–Ω–æ –Ω–∞–ª–∏—á–Ω—ã—Ö</h3>
                    <div class="value" id="totalCash">0 ‚ÇΩ</div>
                    <div class="subvalue">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
                </div>
                <div class="stat-card">
                    <h3>–°–Ω—è—Ç–æ —Å–æ —Å—á—ë—Ç–∞</h3>
                    <div class="value" id="totalFromAccount">0 ‚ÇΩ</div>
                    <div class="subvalue">–í–∫–ª—é—á–∞—è –∫–æ–º–∏—Å—Å–∏—é</div>
                </div>
                <div class="stat-card">
                    <h3>–ü–æ—Ç–µ—Ä–∏ –æ—Ç –æ–±–Ω–∞–ª–∏—á–∏–≤–∞–Ω–∏—è</h3>
                    <div class="value highlight" id="totalLoss">0 ‚ÇΩ</div>
                    <div class="subvalue" id="lossPercent">0% –æ—Ç —Å—É–º–º—ã</div>
                </div>
                <div class="stat-card">
                    <h3>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                    <div class="value" id="totalOps">0</div>
                    <div class="subvalue">–í—ã–¥–∞—á —Å—Ä–µ–¥—Å—Ç–≤</div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
            <div class="chart-container">
                <h3>üìà –†–∞—Å—Ö–æ–¥—ã –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
                <canvas id="monthlyChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>üí∏ –ü–æ—Ç–µ—Ä–∏ –æ—Ç –æ–±–Ω–∞–ª–∏—á–∏–≤–∞–Ω–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
                <canvas id="lossChart"></canvas>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø–∏—Å–µ–π / –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
            <div class="records-section">
                <h2 style="color: #495057; margin-bottom: 20px;">üìã –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
                
                <!-- –î–µ—Å–∫—Ç–æ–ø —Ç–∞–±–ª–∏—Ü–∞ -->
                <div class="table-container desktop-only">
                    <table>
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–°—É–º–º–∞ –Ω–∞–ª–∏—á–Ω—ã—Ö (‚ÇΩ)</th>
                                <th>–°–Ω—è—Ç–æ —Å–æ —Å—á—ë—Ç–∞ (‚ÇΩ)</th>
                                <th>–ö–æ–º–∏—Å—Å–∏—è (%)</th>
                                <th>–ü–æ—Ç–µ—Ä–∏ (‚ÇΩ)</th>
                                <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable">
                            <!-- –ó–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                        </tbody>
                    </table>
                </div>

                <!-- –ú–æ–±–∏–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                <div class="mobile-cards mobile-only" id="mobileCards">
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let records = [];
        let monthlyChart = null;
        let lossChart = null;
        let currentFilter = { from: null, to: null };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadData() {
            const saved = localStorage.getItem('oilExpenses');
            if (saved) {
                records = JSON.parse(saved);
            }
            
            const savedCommission = localStorage.getItem('commissionRate');
            if (savedCommission) {
                document.getElementById('commissionRate').value = savedCommission;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveData() {
            localStorage.setItem('oilExpenses', JSON.stringify(records));
            localStorage.setItem('commissionRate', document.getElementById('commissionRate').value);
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã
        document.getElementById('dateInput').valueAsDate = new Date();

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        function addRecord() {
            const date = document.getElementById('dateInput').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const note = document.getElementById('noteInput').value;
            const commission = parseFloat(document.getElementById('commissionRate').value);

            if (!date || !amount || amount <= 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—É –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }

            // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç: —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ —Å–Ω—è—Ç—å —Å–æ —Å—á—ë—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –Ω—É–∂–Ω—É—é —Å—É–º–º—É –Ω–∞–ª–∏—á–Ω—ã—Ö
            // –§–æ—Ä–º—É–ª–∞: amount / (1 - commission/100)
            const totalFromAccount = amount / (1 - commission / 100);
            const loss = totalFromAccount - amount;

            records.push({
                id: Date.now(),
                date: date,
                amount: amount,
                commission: commission,
                loss: loss,
                totalFromAccount: totalFromAccount,
                note: note
            });

            saveData();
            document.getElementById('amountInput').value = '';
            document.getElementById('noteInput').value = '';
            updateDisplay();
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏
        function deleteRecord(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
                records = records.filter(r => r.id !== id);
                saveData();
                updateDisplay();
            }
        }

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
        function applyFilter() {
            currentFilter.from = document.getElementById('filterFrom').value;
            currentFilter.to = document.getElementById('filterTo').value;
            updateDisplay();
        }

        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞
        function resetFilter() {
            currentFilter = { from: null, to: null };
            document.getElementById('filterFrom').value = '';
            document.getElementById('filterTo').value = '';
            updateDisplay();
        }

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–ø–∏—Å–µ–π
        function getFilteredRecords() {
            let filtered = [...records];
            
            if (currentFilter.from) {
                filtered = filtered.filter(r => r.date >= currentFilter.from);
            }
            
            if (currentFilter.to) {
                filtered = filtered.filter(r => r.date <= currentFilter.to);
            }
            
            return filtered;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        function updateDisplay() {
            updateTable();
            updateAnalytics();
            updateCharts();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        function updateTable() {
            const filtered = getFilteredRecords();
            const sorted = filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Å–∫—Ç–æ–ø —Ç–∞–±–ª–∏—Ü—ã
            const tbody = document.getElementById('recordsTable');
            tbody.innerHTML = sorted.map(record => {
                const totalFromAccount = record.totalFromAccount || (record.amount / (1 - record.commission / 100));
                const loss = record.loss || (totalFromAccount - record.amount);
                
                return `
                <tr>
                    <td>${new Date(record.date).toLocaleDateString('ru-RU')}</td>
                    <td>${record.amount.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚ÇΩ</td>
                    <td style="color: #6c757d;">${totalFromAccount.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚ÇΩ</td>
                    <td>${record.commission}%</td>
                    <td class="highlight">${loss.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚ÇΩ</td>
                    <td>${record.note || '-'}</td>
                    <td><button class="btn btn-delete" onclick="deleteRecord(${record.id})">–£–¥–∞–ª–∏—Ç—å</button></td>
                </tr>
            `}).join('');

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            const mobileCards = document.getElementById('mobileCards');
            mobileCards.innerHTML = sorted.map(record => {
                const totalFromAccount = record.totalFromAccount || (record.amount / (1 - record.commission / 100));
                const loss = record.loss || (totalFromAccount - record.amount);
                
                return `
                <div class="record-card">
                    <div class="record-card-header">
                        <div class="record-date">üìÖ ${new Date(record.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}</div>
                    </div>
                    <div class="record-card-body">
                        <div class="record-row">
                            <span class="record-label">üíµ –í—ã–¥–∞–Ω–æ –Ω–∞–ª–∏—á–Ω—ã—Ö:</span>
                            <span class="record-value">${record.amount.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚ÇΩ</span>
                        </div>
                        <div class="record-row">
                            <span class="record-label">üè¶ –°–Ω—è—Ç–æ —Å–æ —Å—á—ë—Ç–∞:</span>
                            <span class="record-value" style="color: #6c757d;">${totalFromAccount.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚ÇΩ</span>
                        </div>
                        <div class="record-row">
                            <span class="record-label">üìä –ö–æ–º–∏—Å—Å–∏—è:</span>
                            <span class="record-value">${record.commission}%</span>
                        </div>
                        <div class="record-row">
                            <span class="record-label">üí∏ –ü–æ—Ç–µ—Ä–∏:</span>
                            <span class="record-value highlight">${loss.toLocaleString('ru-RU', {minimumFractionDigits: 2})} ‚ÇΩ</span>
                        </div>
                        ${record.note ? `<div class="record-note">üìù ${record.note}</div>` : ''}
                        <button class="btn btn-delete" onclick="deleteRecord(${record.id})" style="margin-top: 10px; width: 100%;">–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                    </div>
                </div>
            `}).join('');

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π
            if (sorted.length === 0) {
                const emptyMessage = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <p style="font-size: 18px; margin-bottom: 10px;">üì≠</p>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>
                        <p style="font-size: 14px; margin-top: 5px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é –≤—ã—à–µ</p>
                    </div>
                `;
                tbody.innerHTML = `<tr><td colspan="7">${emptyMessage}</td></tr>`;
                mobileCards.innerHTML = emptyMessage;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        function updateAnalytics() {
            const filtered = getFilteredRecords();
            const totalCash = filtered.reduce((sum, r) => sum + r.amount, 0);
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π
            const totalFromAccount = filtered.reduce((sum, r) => {
                const fromAccount = r.totalFromAccount || (r.amount / (1 - r.commission / 100));
                return sum + fromAccount;
            }, 0);
            
            const totalLoss = filtered.reduce((sum, r) => {
                const loss = r.loss || ((r.amount / (1 - r.commission / 100)) - r.amount);
                return sum + loss;
            }, 0);
            
            const avgCommission = filtered.length > 0 
                ? filtered.reduce((sum, r) => sum + r.commission, 0) / filtered.length 
                : 0;

            document.getElementById('totalCash').textContent = 
                totalCash.toLocaleString('ru-RU', {minimumFractionDigits: 2}) + ' ‚ÇΩ';
            document.getElementById('totalFromAccount').textContent = 
                totalFromAccount.toLocaleString('ru-RU', {minimumFractionDigits: 2}) + ' ‚ÇΩ';
            document.getElementById('totalLoss').textContent = 
                totalLoss.toLocaleString('ru-RU', {minimumFractionDigits: 2}) + ' ‚ÇΩ';
            document.getElementById('lossPercent').textContent = 
                avgCommission.toFixed(2) + '% —Å—Ä–µ–¥–Ω—è—è –∫–æ–º–∏—Å—Å–∏—è';
            document.getElementById('totalOps').textContent = filtered.length;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function updateCharts() {
            const filtered = getFilteredRecords();
            
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º
            const monthlyData = {};
            const monthlyLoss = {};

            filtered.forEach(record => {
                const date = new Date(record.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[key]) {
                    monthlyData[key] = 0;
                    monthlyLoss[key] = 0;
                }
                
                monthlyData[key] += record.amount;
                monthlyLoss[key] += record.loss;
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' });
            });

            // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤
            const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChart) monthlyChart.destroy();
            
            monthlyChart = new Chart(ctxMonthly, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–í—ã–¥–∞–Ω–æ –Ω–∞–ª–∏—á–Ω—ã—Ö (‚ÇΩ)',
                        data: sortedMonths.map(m => monthlyData[m]),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                                }
                            }
                        }
                    }
                }
            });

            // –ì—Ä–∞—Ñ–∏–∫ –ø–æ—Ç–µ—Ä—å
            const ctxLoss = document.getElementById('lossChart').getContext('2d');
            if (lossChart) lossChart.destroy();
            
            lossChart = new Chart(ctxLoss, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–ü–æ—Ç–µ—Ä–∏ –æ—Ç –∫–æ–º–∏—Å—Å–∏–∏ (‚ÇΩ)',
                        data: sortedMonths.map(m => monthlyLoss[m]),
                        backgroundColor: 'rgba(220, 53, 69, 0.2)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('ru-RU') + ' ‚ÇΩ';
                                }
                            }
                        }
                    }
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–º–∏—Å—Å–∏–∏
        document.getElementById('commissionRate').addEventListener('change', function() {
            saveData();
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadData();
        updateDisplay();
    </script>
</body>
</html>
